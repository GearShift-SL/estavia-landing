---
import { getCollection } from 'astro:content';
import PageLayout from '@/layouts/PageLayout.astro';
import PostsByCategory from '@/components/blog/PostsByCategory.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });

  // Get all the unique languages from the blog posts
  const languages = [...new Set(posts.map((post) => post.id.split('/')[0]))];

  // Create a flat array of paths for each language and category combination
  const paths: Array<{
    params: { lang: string; category: string };
    props: { posts: any[] };
  }> = [];

  languages.forEach((lang) => {
    const postsByLang = posts.filter((post) => post.id.split('/')[0] === lang);

    // Get unique categories for this language
    const categories = [...new Set(postsByLang.map((post) => post.data.category.toLowerCase()))];

    // Add paths for each category in this language
    categories.forEach((category) => {
      const postsForCategory = postsByLang.filter((post) => post.data.category.toLowerCase() === category);
      paths.push({
        params: { lang, category: category.toLowerCase() },
        props: { posts: postsForCategory },
      });
    });
  });

  return paths;
}

const { category, lang } = Astro.params;
const { posts } = Astro.props;

// Create metadata for the page
const metadata = {
  title: `Publicaciones en la categoría: ${category}`,
  description: `Explora todas las publicaciones de Estavia, el agente inmobiliario de IA, en la categoría: ${category}. Consejos, novedades y recursos útiles.`,
};
---

<PageLayout metadata={metadata}>
  <div class="max-w-3xl mx-auto px-4 py-16">
    <PostsByCategory posts={posts} category={category} lang={lang} />
  </div>
</PageLayout>
